{{/*
Stackgres PostgreSQL Cluster
Only created when postgres.operator.enabled is true and postgres.external.enabled is false
*/}}
{{- if and .Values.postgres.operator.enabled (not .Values.postgres.external.enabled) }}
---
apiVersion: stackgres.io/v1
kind: SGCluster
metadata:
  name: {{ .Values.postgres.operator.name }}
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
spec:
  instances: {{ .Values.postgres.operator.instances }}
  postgres:
    version: {{ .Values.postgres.operator.version | quote }}
    {{- if .Values.postgres.operator.extensions }}
    extensions:
      {{- toYaml .Values.postgres.operator.extensions | nindent 6 }}
    {{- end }}
  pods:
    persistentVolume:
      size: {{ .Values.postgres.operator.storage.size | quote }}
      {{- if .Values.postgres.operator.storage.storageClass }}
      storageClass: {{ .Values.postgres.operator.storage.storageClass | quote }}
      {{- else if .Values.global.storageClass }}
      storageClass: {{ .Values.global.storageClass | quote }}
      {{- end }}
    scheduling:
      nodeSelector: {}
      tolerations: []
  configurations:
    sgPostgresConfig: {{ .Values.postgres.operator.name }}-config
    {{- if .Values.postgres.operator.connectionPooling.enabled }}
    sgPoolingConfig: {{ .Values.postgres.operator.name }}-pooling
    {{- end }}
  managedSql:
    scripts:
      - sgScript: {{ .Values.postgres.operator.name }}-init
---
apiVersion: stackgres.io/v1
kind: SGPostgresConfig
metadata:
  name: {{ .Values.postgres.operator.name }}-config
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
spec:
  postgresVersion: {{ .Values.postgres.operator.version | int | quote }}
  {{- if .Values.postgres.operator.postgresConfig }}
  postgresql.conf:
    {{- range $key, $value := .Values.postgres.operator.postgresConfig }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
  {{- end }}
---
{{- if .Values.postgres.operator.connectionPooling.enabled }}
apiVersion: stackgres.io/v1
kind: SGPoolingConfig
metadata:
  name: {{ .Values.postgres.operator.name }}-pooling
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
spec:
  pgBouncer:
    pgbouncer.ini:
      pgbouncer:
        max_client_conn: {{ .Values.postgres.operator.connectionPooling.maxConnections | quote }}
        default_pool_size: "50"
        reserve_pool_size: "25"
{{- end }}
---
apiVersion: stackgres.io/v1
kind: SGScript
metadata:
  name: {{ .Values.postgres.operator.name }}-init
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
spec:
  scripts:
    - id: 0
      name: create-databases
      script: |
        -- Create FlexPrice database
        SELECT 'CREATE DATABASE {{ .Values.postgres.database }}' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.postgres.database }}')\gexec
        -- Create Temporal databases
        SELECT 'CREATE DATABASE temporal' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'temporal')\gexec
        SELECT 'CREATE DATABASE temporal_visibility' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'temporal_visibility')\gexec
    - id: 1
      name: enable-extensions
      database: temporal_visibility
      script: |
        CREATE EXTENSION IF NOT EXISTS btree_gin;
{{- end }}
