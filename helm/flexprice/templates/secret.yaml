{{/*
Secrets for FlexPrice
*/}}
{{- if not .Values.secrets.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-secrets
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  auth-secret: {{ .Values.auth.secret | default (include "flexprice.randomSecret" .) | b64enc | quote }}
  encryption-key: {{ .Values.secrets.encryptionKey | default (include "flexprice.randomSecret" .) | b64enc | quote }}
  {{- if eq .Values.auth.provider "supabase" }}
  supabase-service-key: {{ .Values.auth.supabase.serviceKey | b64enc | quote }}
  {{- end }}
{{- end }}
---
{{/*
PostgreSQL credentials
*/}}
{{- if and (not .Values.postgres.external.enabled) (not .Values.postgres.external.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-postgres-credentials
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  username: {{ .Values.postgres.user | b64enc | quote }}
  password: {{ .Values.postgres.password | default (include "flexprice.randomPassword" .) | b64enc | quote }}
{{- else if and .Values.postgres.external.enabled (not .Values.postgres.external.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-postgres-credentials
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  username: {{ .Values.postgres.external.user | b64enc | quote }}
  password: {{ .Values.postgres.external.password | b64enc | quote }}
{{- end }}
---
{{/*
ClickHouse credentials
*/}}
{{- if and (not .Values.clickhouse.external.enabled) (not .Values.clickhouse.external.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-clickhouse-credentials
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  username: {{ .Values.clickhouse.user | b64enc | quote }}
  password: {{ .Values.clickhouse.password | default (include "flexprice.randomPassword" .) | b64enc | quote }}
{{- else if and .Values.clickhouse.external.enabled (not .Values.clickhouse.external.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-clickhouse-credentials
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  username: {{ .Values.clickhouse.external.user | b64enc | quote }}
  password: {{ .Values.clickhouse.external.password | b64enc | quote }}
{{- end }}
---
{{/*
Kafka SASL credentials (only when external with SASL)
*/}}
{{- if and .Values.kafka.external.enabled .Values.kafka.external.sasl.enabled (not .Values.kafka.external.sasl.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-kafka-credentials
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  username: {{ .Values.kafka.external.sasl.user | b64enc | quote }}
  password: {{ .Values.kafka.external.sasl.password | b64enc | quote }}
{{- end }}
---
{{/*
Temporal API key (only when external with API key)
*/}}
{{- if and (dig "external" "enabled" false .Values.temporal) (dig "external" "apiKey" "" .Values.temporal) (not (dig "external" "existingSecret" "" .Values.temporal)) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-temporal-credentials
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  api-key: {{ .Values.temporal.external.apiKey | b64enc | quote }}
{{- end }}
---
{{/*
Email (Resend) credentials
*/}}
{{- if and .Values.email.enabled .Values.email.resendApiKey (not .Values.email.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-email
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  resend-api-key: {{ .Values.email.resendApiKey | b64enc | quote }}
{{- end }}
---
{{/*
Svix credentials
*/}}
{{- if and .Values.webhook.svix.enabled .Values.webhook.svix.authToken (not .Values.webhook.svix.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-svix
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  auth-token: {{ .Values.webhook.svix.authToken | b64enc | quote }}
{{- end }}
---
{{/*
S3 credentials
*/}}
{{- if and .Values.s3.enabled .Values.s3.credentials.accessKeyId (not .Values.s3.credentials.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "flexprice.fullname" . }}-s3
  labels:
    {{- include "flexprice.labels" . | nindent 4 }}
type: Opaque
data:
  access-key-id: {{ .Values.s3.credentials.accessKeyId | b64enc | quote }}
  secret-access-key: {{ .Values.s3.credentials.secretAccessKey | b64enc | quote }}
{{- end }}
